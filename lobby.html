<!DOCTYPE html>
<html lang="en">
  <include-header />
  <body x-data="lobby">
    Player ID: <span x-text="playerId"></span>
    <!-- TTODO Changing name after joining a lobby is a bit jank - name doesn't update, you list your old name as your opponent, etc. -->
    <input x-model="playerName" placeholder="Player Name" />
    <button @click="savePlayerName()">Save</button>

    <!-- TTODO Lobby chat - should just be a message of type='lobby' and subtype='chat' -->
    <!-- TTODO Clean up baby's first UI, aka our super roughed out testing one -->

    <br />
    Lobbies:
    <ul>
      <template x-for="currentLobby in lobbies">
        <li>
          <span x-text="currentLobby.title"></span>
          - Players: <span x-text="currentLobby.players"></span>
          <template x-if="currentLobby.hasPassword && currentLobby.showPasswordEntry">
            <input
              x-init="$el.focus()"
              type="password"
              placeholder="Lobby requires a password"
              x-model="enteredPassword"
              @keyup.enter="clickLobby(currentLobby)"
            />
          </template>
          <template x-if="!readying">
            <button
              @click="clickLobby(currentLobby)"
              :disabled="!isInLobby(currentLobby) && currentLobby.players.length >= 2"
            >
              <span x-text="!isInLobby(currentLobby) ? 'Join' : 'Leave'"></span>
            </button>
          </template>
        </li>
      </template>
    </ul>

    <template x-if="joinedId && getJoinedLobby()">
      <div class="panel">
        You are in a game lobby for <span x-text="getJoinedLobby().gameId"></span>
        <br />
        Your opponent is <span x-text="getOpponentName()"></span>
        <template x-if="!readying">
          <label style="font-size: 48px">
            <input type="checkbox" @click="markReady($el)">
            I'm Ready
          </label>
        </template>
        <template x-if="readying">
          <div>
            <span x-text="`You will be going ${isFirst ? 'FIRST' : 'SECOND'}`"></span>
            <br />
            <span x-text="`Game starting in ${countdownSeconds}...`"></span>
          </div>
        </template>
      </div>
    </template>

    <template x-if="!joinedId && !readying">
      <div>
        <button
          @click="clickQuickplay()"
          class="success"
          title="Join an open lobby or create a default new lobby"
        >
          Quickplay
        </button>
        <button
          @click="clickCustomGame()"
          class="accent"
          title="Create a custom lobby with configurable options"
        >
          Custom Game
        </button>
        <button
          @click="clickTestGame()"
          class="default"
          title="Play against a passive AI opponent to try out the game and website"
        >
          Test Game vs AI
        </button>
      </div>
    </template>

    <!--
      TTODO Lobby system
      - What to do with an idle opponent? Timeout to kick or leave game?
      - Rejoining games on crash? Maybe keep current playerId or hidden key in local storage, then can check if joining a game that had a leaver/crash/timeout?
        - Honestly don't need to do this extra key and can just use playerId from local storage (already done)
      - Handle page refresh while an action (such as target mode) is in progress
      - Win/loss screen and proper end of game
  
      Implementation details:
      lobby.html page, server maintains a list (in memory for now, Deno KV/Redis/CouchDB/LowDB eventually) of Games (gameId, title, password, observers, timeLimit) that are rendered into a Lobby List on the page
      1. To start auto-add a plain game and focus on getting joining/gamestate/etc. working
      2. Make "create game" UI
      Can click join to hop into a middle step of a waiting lobby, when both ready there launch to game.html
      For now ignore auto_player and need 2 actual browsers
  
      So existing Websocket approach should "just work" once we tweak the gameId generation and setting
      What WILL be a problem is the gamestate which needs to be brought up another level - also everything in sub-files needs to be moved up, such as actions.undoStack (likely put INSIDE actions like we do with gs.universal)
      -->

    <script src="./clientjs/lobby.js"></script>
  </body>
</html>
