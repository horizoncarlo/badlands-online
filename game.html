<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <base href="/" />
    <meta
      name="viewport"
      content="width=device-width, height=device-height, initial-scale=1"
    />
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèú</text></svg>"
    />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@lowlighter/matcha@3.0.0/dist/matcha.min.css" />
    <link rel="stylesheet" href="./css/matcha-override.css" />
    <link rel="stylesheet" href="./css/animation.css" />
    <link rel="stylesheet" href="./css/central.css" />

    <title>Badlands Online</title>

    <script type="text/javascript">
      const CLIENT_WEBSOCKET_ADDRESS = '${CLIENT_WEBSOCKET_ADDRESS}';
      let playerId = '${PLAYER_ID}'; // Replaced server side before returning the page
    </script>

    <script src="./clientjs/websocket.js"></script>
    <script src="./sharedjs/gamestate.mjs" type="module"></script>
    <script src="./sharedjs/utils.mjs" type="module"></script>
    <script src="./sharedjs/actions.mjs" type="module"></script>

    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs/dist/cdn.min.js"
    ></script>
  </head>
  <body x-data="gs">
    <section
      x-data="ui"
      :class="(inGame && targetMode.enabled) && `target-mode-section target-mode-section-${targetMode.type}`"
    >
      <header>
        <menu>
          <li>Target Mode=<span x-text="targetMode.enabled"></span></li>
          <li>
            Debug Menu
            <menu>
              <li>
                Customize Layout
                <menu>
                  <li>Show Chat</li>
                  <li>Show Log</li>
                  <li>Show Timer</li>
                </menu>
              </li>
            </menu>
          </li>
          <template x-if="!inGame">
            <li>
              Join As
              <menu>
                <!-- TODO One potential issue with our Alpine.js approach is the mix of heavy lifting here in the UI and heavy lifting in the "backing" plain JS. Like should this action call be wrapped in a function? -->
                <li onclick="action.joinGame({player: 'player1'})">Be Player 1</li>
                <li onclick="action.joinGame({player: 'player2'})">Be Player 2</li>
              </menu>
            </li>
          </template>
          <template x-if="inGame">
            <li>
              Card Scale
              <menu>
                <li>
                  <input type="range" min="5" max="300" step="5" x-model="cardScale" @input="applyCardScale()" />
                  <span x-text="cardScale + '%'"></span>
                </li>
              </menu>
            </li>
          </template>
          <template x-if="inGame">
            <template x-if="!turn.currentPlayer || myPlayerNum !== turn.currentPlayer">
              <li @click="action.startTurn()">Start Turn</li>
            </template>
          </template>
          <template x-if="inGame">
            <template x-if="myPlayerNum === turn.currentPlayer">
              <li @click="action.endTurn()">End Turn</li>
            </template>
          </template>
          <template x-if="inGame">
            <!-- TODO Need to disable various UI elements when it's not our turn, such as drawing or playing a card -->
            <!-- TODO Menu UI is an overlapping ugly thing due to <template> not allowing more than a single child -->
            <li class="menu-right">
              <template x-if="turn.currentPlayer">
                <div>
                  <template x-if="myPlayerNum === turn.currentPlayer">
                    <span x-text="`Your Turn ${turn[myPlayerNum].turnCount}`"></span>
                  </template>
                  <template x-if="myPlayerNum !== turn.currentPlayer">
                    <span x-text="`Opponent Turn ${turn[utils.getOppositePlayerNum(myPlayerNum)].turnCount}`"></span>
                  </template>
                </div>
              </template>
              <template x-if="!turn.currentPlayer">
                <span>Waiting for Opponent...</span>
              </template>
            </li>
          </template>
        </menu>
      </header>

      <template x-if="!inGame">
        <h1>To start the game join as a player from the menu</h1>
      </template>

      <template x-if="inGame && targetMode.enabled && targetMode.help">
        <div class="target-mode-help panel">
          <span x-text="targetMode.help"></span>
        </div>
      </template>

      <!-- TODO Realistically we wouldn't even GET to this page without being a game (after joining from a lobby), so all these inGame checks will become needless-->
      <template x-if="inGame">
        <div
          class="repositionable"
          draggable="true"
          @dragstart="repositionStart($event)"
          @dragend="repositionEnd($event, $el, [repositionOffsetX, repositionOffsetY])"
        >
          <div
            class="bright-hover"
            title="Draw a card for 2 Water"
            @mouseover="showWaterCost(2)"
            @mouseout="hideWaterCost()"
          >
            <img
              class="card-size"
              onclick="action.drawCard({ fromWater: true })"
              src="images/cards/people/punk.png"
              draggable="false"
            />
          </div>
          <template x-if="draggedCard">
            <div
              class="junk-pile card-size bd-attention"
              title="Drag your card here to use the Junk effect"
              @dragleave="dragLeaveHighlight($el, 'fg-attention')"
              @dragover.prevent="dragOverHighlight($el, 'fg-attention')"
              @drop.prevent="dropCardInJunk($el)"
            >
              Junk Card
              <div class="icon">üóë</div>
            </div>
          </template>
        </div>
      </template>
      <template x-if="drawAnimationCount > 0">
        <template x-for="anim in drawAnimationCount">
          <img src="images/cards/people/punk.png" class="draw-animation card-size" />
        </template>
      </template>

      <template x-if="inGame">
        <!-- Note this approach can be used on ANY element to make it repositionable in the page -->
        <div
          draggable="true"
          @dragstart="repositionStart($event)"
          @dragend="repositionEnd($event, $el, [repositionOffsetX, repositionOffsetY])"
          class="repositionable panel water-wrap bd-accent"
        >
          <template x-if="getPlayerData().waterCount > 0">
            <template x-for="water in getPlayerData().waterCount">
              <img x-init="waterTokenEles.push($el)" src="images/water.png" class="water-token" draggable="false" />
            </template>
          </template>
          <template x-if="getPlayerData().waterCount <= 0">
            <span>No Water remains</span>
          </template>
        </div>
      </template>

      <template x-if="inGame && getOpponentCamps().length">
        <div class="slots opponent-camps">
          <template x-for="camp in getOpponentCamps()">
            <div class="opponent-camp">
              <img
                :id="`target_${camp.id}`"
                draggable="false"
                :alt="camp.img"
                :src="'images/cards/camps/' + camp.img"
                class="card-size"
              />
            </div>
          </template>
          <span class="opponent-card-count panel" x-text="`${getOpponentCardCount()}\nCards`"></span>
        </div>
      </template>

      <template x-if="inGame">
        <template x-for="(playerSlots, playerNum) in getSlots()">
          <div
            x-data="{ isMySlot: playerNum === myPlayerNum }"
            :class="'slots ' + (isMySlot ? 'my-slots' : 'opponent-slots')"
          >
            <template x-for="slot in playerSlots">
              <div
                class="bd-default"
                @dragleave="dragLeaveHighlight($el)"
                @dragover.prevent="isMySlot && dragOverSlot(slot, $el)"
                @drop.prevent="isMySlot && dropCardInSlot(slot, $el)"
              >
                <template x-if="slot.content">
                  <!-- TODO Add water cost to abilities, then show them when mousing over a card: @mouseover="isMySlot && showWaterCost(2)" @mouseout="isMySlot && hideWaterCost()" -->
                  <!-- TODO Will need to determine WHICH ability to use on a card in the rare case there are options - then pass that as part of useCard -->
                  <img
                    :id="`target_${slot.content.id}`"
                    @click="isMySlot && action.useCard({card: slot.content})"
                    draggable="false"
                    :alt="slot.content.img"
                    :src="'images/cards/people/' + slot.content.img"
                    :class="'bright-hover card-size slot-card ' + (slot.content.damage >= 1 ? ' damaged-card' : '')"
                  />
                </template>
              </div>
            </template>
          </div>
        </template>
      </template>

      <template x-if="inGame">
        <footer>
          <!-- TODO Hotkey for this swap -->
          <button
            @click="flipTray()"
            :class="'flip-tray ' + (trayIsCamps ? 'variant' : 'active')"
            title="Flip tray between your camps and hand"
          >
            <u>F</u>lip Tray<div class="icon">üóò</div>
          </button>

          <fieldset :class="'panel tray ' + (trayIsCamps ? 'active' : 'variant')">
            <legend><span x-text="getTrayLegend()"></span></legend>

            <template x-if="trayIsCamps">
              <template x-for="camp in getMyCamps()">
                <div>
                  <img
                    :id="`target_${camp.id}`"
                    draggable="false"
                    :alt="camp.img"
                    :src="'images/cards/camps/' + camp.img"
                    class="card-size"
                  />
                </div>
              </template>
            </template>

            <template x-if="trayIsCards && myPlayerNum">
              <!-- TODO Space properly when no cards are in hand, or put a shrug emoji or something as a filler -->
              <template x-for="card in getMyCards()">
                <div>
                  <img
                    :id="`target_${card.id}`"
                    :alt="card.img"
                    :src="'images/cards/people/' + card.img"
                    :title="'Click and drag to play for ' + card.cost + ' Water'"
                    draggable="true"
                    @dragstart="draggedCard = card"
                    @dragend="draggedCard = null"
                    @mouseover="showWaterCost(card.cost)"
                    @mouseout="hideWaterCost()"
                    @error="$el.classList.add('card-error')"
                    class="card card-size"
                  />
                </div>
              </template>
            </template>
          </fieldset>
        </footer>
      </template>

      <!-- TODO Start simple with the chat & log, but go absolutely wild with features later - emojis, quick emotes, press up for last message, new message count in page title, trigger visual effects on opponent's screen, etc. -->
      <template x-if="inGame">
        <fieldset
          class="repositionable chat panel bd-severe"
          draggable="true"
          @dragstart="repositionStart($event)"
          @dragend="repositionEnd($event, $el, [repositionOffsetX, repositionOffsetY])"
        >
          <legend class="severe" @click="applyChatMax({alsoUpdate: true})">
            Log <small>(press <b>T</b> to focus)</small>
            <div class="inline icon-sm">‚Ü®</div>
          </legend>
          <template x-if="chat.length === 0">
            <span>No messages yet...</span>
          </template>
          <div x-effect="scrollChatToBottom($el, chat.length, chatMax)" class="chat-wrap">
            <template x-for="message in chat">
              <div x-text="message"></div>
            </template>
          </div>
          <input x-ref="chatIn" x-model="currentChat" @keyup.enter="submitChat($el)" />
        </fieldset>
      </template>

      <template x-if="inGame" x-teleport="body">
        <dialog id="campPromptDialog" class="camps-dialog">
          <header>
            <h2>Choose Your 3 Camps</h2>
          </header>
          <p>To start the game you choose <span x-text="3 - selectedCampCount()"></span> camps from a random option of 6</p>
          <div class="camps-dialog-wrap">
            <template x-for="camp in getMyCamps()">
              <div @click="chooseCamp(camp)" class="camp-choice-wrap">
                <img
                  :alt="camp.img"
                  :src="'images/cards/camps/' + camp.img"
                  draggable="false"
                  :class="'camp-choice' + (camp.selected ? ' camp-choice-sel' : '')"
                />
              </div>
            </template>
          </div>
          <footer>
            <template x-if="selectedCampCount() > 0">
              <span>Your starting hand size will be <span x-text="selectedCampDrawCount()"></span> cards</span>
            </template>
            <button onclick="doneChooseCamps()" :disabled="selectedCampCount() !== 3">Done Choices</button>
          </footer>
        </dialog>
      </template>
    </section>

    <!-- JS scripts at the bottom like it's 1995 -->
    <script src="./clientjs/badlands.js"></script>
  </body>
</html>
