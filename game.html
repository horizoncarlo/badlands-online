<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <base href="/" />
    <meta
      name="viewport"
      content="width=device-width, height=device-height, initial-scale=1"
    />
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèú</text></svg>"
    />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@lowlighter/matcha@3.0.0/dist/matcha.min.css" />
    <link rel="stylesheet" href="./css/matcha-override.css" />
    <link rel="stylesheet" href="./css/animation.css" />
    <link rel="stylesheet" href="./css/central.css" />

    <title>Badlands Online</title>

    <script type="text/javascript">
      const CLIENT_WEBSOCKET_ADDRESS = '${CLIENT_WEBSOCKET_ADDRESS}';
      let playerId = '${PLAYER_ID}'; // Replaced server side before returning the page
    </script>

    <script src="./clientjs/websocket.js"></script>
    <script src="./sharedjs/gamestate.mjs" type="module"></script>
    <script src="./sharedjs/utils.mjs" type="module"></script>
    <script src="./sharedjs/actions.mjs" type="module"></script>

    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs/dist/cdn.min.js"
    ></script>
  </head>
  <body x-data="gs">
    <section x-data="ui">
      <header>
        <menu>
          <li>
            Debug Menu
            <menu>
              <li>
                Customize Layout
                <menu>
                  <li>Show Chat</li>
                  <li>Show Log</li>
                  <li>Show Timer</li>
                </menu>
              </li>
            </menu>
          </li>
          <template x-if="!inGame">
            <li>
              Join As
              <menu>
                <li onclick="action.joinGame('player1')">Be Player 1</li>
                <li onclick="action.joinGame('player2')">Be Player 2</li>
              </menu>
            </li>
          </template>
          <template x-if="inGame">
            <li>
              Card Scale
              <menu>
                <li>
                  <input type="range" min="5" max="300" step="5" x-model="cardScale" @input="applyCardScale()" />
                  <span x-text="cardScale + '%'"></span>
                </li>
              </menu>
            </li>
          </template>
          <template x-if="inGame">
            <template x-if="!turn.currentPlayer || myPlayerNum !== turn.currentPlayer">
              <li @click="action.startTurn()">Start Turn</li>
            </template>
          </template>
          <template x-if="inGame">
            <template x-if="myPlayerNum === turn.currentPlayer">
              <li @click="action.endTurn()">End Turn</li>
            </template>
          </template>
          <template x-if="inGame">
            <!-- TODO Need to disable various UI elements when it's not our turn, such as drawing or playing a card -->
            <!-- TODO Menu UI is an overlapping ugly thing due to <template> not allowing more than a single child -->
            <li class="menu-right">
              <template x-if="turn.currentPlayer">
                <div>
                  <template x-if="myPlayerNum === turn.currentPlayer">
                    <span x-text="`Your Turn ${turn[myPlayerNum].turnCount}`"></span>
                  </template>
                  <template x-if="myPlayerNum !== turn.currentPlayer">
                    <span x-text="`Opponent Turn ${turn[utils.getOppositePlayerNum(myPlayerNum)].turnCount}`"></span>
                  </template>
                </div>
              </template>
              <template x-if="!turn.currentPlayer">
                <span>Waiting for Opponent...</span>
              </template>
            </li>
          </template>
        </menu>
      </header>

      <template x-if="!inGame">
        <h1>To start the game join as a player from the menu</h1>
      </template>

      <!-- TODO Realistically we wouldn't even GET to this page without being a game (after joining from a lobby), so all these inGame checks will become needless-->
      <template x-if="inGame">
        <div
          class="draw-pile"
          title="Draw a card for 2 Water"
          @mouseover="showWaterCost(2)"
          @mouseout="hideWaterCost()"
          draggable="true"
          @dragstart="repositionStart($event)"
          @dragend="repositionEnd($event, $el, [repositionOffsetX, repositionOffsetY])"
          class="repositionable"
        >
          <img
            class="card-size"
            onclick="action.drawCard({ fromWater: true })"
            src="images/cards/people/punk.png"
            draggable="false"
          />
        </div>
      </template>
      <template x-if="drawAnimationCount > 0">
        <template x-for="anim in drawAnimationCount">
          <img src="images/cards/people/punk.png" class="draw-animation card-size" />
        </template>
      </template>

      <template x-if="inGame">
        <!-- Note this approach can be used on ANY element to make it repositionable in the page -->
        <div
          draggable="true"
          @dragstart="repositionStart($event)"
          @dragend="repositionEnd($event, $el, [repositionOffsetX, repositionOffsetY])"
          class="repositionable panel water-wrap bd-accent"
        >
          <template x-if="getPlayerData().waterCount > 0">
            <template x-for="water in getPlayerData().waterCount">
              <img x-init="waterTokenEles.push($el)" src="images/water.png" class="water-token" draggable="false" />
            </template>
          </template>
          <template x-if="getPlayerData().waterCount <= 0">
            <span>No Water remains</span>
          </template>
        </div>
      </template>

      <template x-if="inGame">
        <template x-for="(playerSlots, playerNum) in getSlots()">
          <div :class="'slots ' + (playerNum === myPlayerNum ? 'my-slots' : 'opponent-slots')">
            <template x-for="slot in playerSlots">
              <div
                class="bd-default"
                @dragleave="dragLeaveSlot($el)"
                @dragover.prevent="dragOverSlot(slot, playerNum, $el)"
                @drop.prevent="dropCardInSlot(slot, playerNum, $el, event)"
              >
                <template x-if="slot.content">
                  <img
                    draggable="false"
                    :alt="slot.content.img"
                    :src="'images/cards/people/' + slot.content.img"
                    :class="'card-size' + (slot.content.damage >= 1 ? ' damaged-card' : '')"
                  />
                </template>
              </div>
            </template>
          </div>
        </template>
      </template>

      <template x-if="inGame">
        <footer>
          <!-- TODO Hotkey for this swap -->
          <button
            @click="flipTray()"
            :class="'flip-tray ' + (trayIsCamps ? 'variant' : 'active')"
            title="Flip tray between your camps and hand"
          >
            Flip <u>T</u>ray<div>üóò</div>
          </button>

          <fieldset :class="'panel tray ' + (trayIsCamps ? 'active' : 'variant')">
            <legend><span x-text="getTrayLegend()"></span></legend>

            <template x-if="trayIsCamps">
              <template x-for="camp in getMyCamps()">
                <div>
                  <img
                    draggable="false"
                    :alt="camp.img"
                    :src="'images/cards/camps/' + camp.img"
                    class="card-size"
                  />
                </div>
              </template>
            </template>

            <template x-if="trayIsCards && myPlayerNum">
              <!-- TODO Space properly when no cards are in hand-->
              <template x-for="card in getMyCards()">
                <div>
                  <img
                    :alt="card.img"
                    :src="'images/cards/people/' + card.img"
                    :title="'Click and drag to play for ' + card.cost + ' Water'"
                    draggable="true"
                    @dragstart="draggingCard = true; $event.dataTransfer.setData('text/plain', card.id);"
                    @dragend="draggingCard = false"
                    @mouseover="showWaterCost(card.cost)"
                    @mouseout="hideWaterCost()"
                    @error="$el.classList.add('card-error')"
                    class="card card-size"
                  />
                </div>
              </template>
            </template>
          </fieldset>
        </footer>
      </template>

      <template x-if="inGame" x-teleport="body">
        <dialog id="campPromptDialog" class="camps-dialog">
          <header>
            <h2>Choose Your 3 Camps</h2>
          </header>
          <p>To start the game you choose <span x-text="3 - selectedCampCount()"></span> camps from a random option of 6</p>
          <div class="camps-dialog-wrap">
            <template x-for="camp in getMyCamps()">
              <div @click="chooseCamp(camp)" class="camp-choice-wrap">
                <img
                  :alt="camp.img"
                  :src="'images/cards/camps/' + camp.img"
                  draggable="false"
                  :class="'camp-choice' + (camp.selected ? ' camp-choice-sel' : '')"
                />
              </div>
            </template>
          </div>
          <footer>
            <template x-if="selectedCampCount() > 0">
              <span>Your starting hand size will be <span x-text="selectedCampDrawCount()"></span> cards</span>
            </template>
            <button onclick="doneChooseCamps()" :disabled="selectedCampCount() !== 3">Done Choices</button>
          </footer>
        </dialog>
      </template>
    </section>

    <!-- JS scripts at the bottom like it's 1995 -->
    <script src="./clientjs/badlands.js"></script>
  </body>
</html>
