<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <base href="/" />
    <meta
      name="viewport"
      content="width=device-width, height=device-height, initial-scale=1"
    />
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèú</text></svg>"
    />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@lowlighter/matcha@3.0.0/dist/matcha.min.css" />
    <link rel="stylesheet" href="./css/matcha-override.css" />
    <link rel="stylesheet" href="./css/animation.css" />
    <link rel="stylesheet" href="./css/central.css" />

    <title>Badlands Online</title>

    <script type="text/javascript">
      const CLIENT_WEBSOCKET_ADDRESS = '${CLIENT_WEBSOCKET_ADDRESS}';
      let playerId = '${PLAYER_ID}'; // Replaced server side before returning the page
      <component-js />;
    </script>

    <script src="./clientjs/websocket.js"></script>
    <script src="./sharedjs/gamestate.mjs" type="module"></script>
    <script src="./sharedjs/utils.mjs" type="module"></script>
    <script src="./sharedjs/actions.mjs" type="module"></script>

    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs/dist/cdn.min.js"
    ></script>
  </head>
  <body x-data="gs">
    <section
      x-data="ui"
      :class="(inGame && targetMode.enabled) && `target-mode-section target-mode-section-${targetMode.cursor || targetMode.type}`"
    >
      <header>
        <menu :class="targetMode.enabled ? 'invalid-target' : ''">
          <li>
            Debug Menu
            <menu>
              <li @click="action.dumpDebug()">Log Gamestate</li>
            </menu>
          </li>
          <template x-if="!inGame">
            <li class="success">
              Join As
              <menu>
                <!-- TODO One potential issue with our Alpine.js approach is the mix of heavy lifting here in the UI and heavy lifting in the "backing" plain JS. Like should this action call be wrapped in a function? -->
                <li @click="action.joinGame({player: 'player1'})">Be Player <u>1</u></li>
                <li @click="action.joinGame({player: 'player2'})">Be Player <u>2</u></li>
              </menu>
            </li>
          </template>
          <template x-if="inGame">
            <li>
              Card Scale
              <menu>
                <li>
                  <input type="range" min="5" max="300" step="5" x-model="cardScale" @input="applyCardScale()" />
                  <span x-text="`Cards: ${cardScale}%`"></span>

                  <input type="range" min="5" max="300" step="5" x-model="hoverScale" @input="applyHoverScale()" />
                  <span x-text="`Hover: ${hoverScale}%`"></span>
                </li>
              </menu>
            </li>
          </template>
          <template x-if="inGame">
            <template x-if="myPlayerNum === turn.currentPlayer">
              <li @click="userUndo()"><u>U</u>ndo</li>
            </template>
          </template>
          <template x-if="inGame">
            <template x-if="!turn.currentPlayer || myPlayerNum !== turn.currentPlayer">
              <li @click="action.startTurn()" class="success">Start Turn</li>
            </template>
          </template>
          <template x-if="inGame">
            <template x-if="myPlayerNum === turn.currentPlayer">
              <li @click="userEndTurn()" class="attention"><u>E</u>nd Turn</li>
            </template>
          </template>
          <template x-if="inGame">
            <!-- TODO Need to disable various UI elements when it's not our turn, such as drawing or playing a card -->
            <!-- TODO Menu UI is an overlapping ugly thing due to <template> not allowing more than a single child -->
            <li class="menu-right">
              <template x-if="turn.currentPlayer">
                <div>
                  <template x-if="myPlayerNum === turn.currentPlayer">
                    <span x-text="`Your Turn ${turn[myPlayerNum].turnCount}`"></span>
                  </template>
                  <template x-if="myPlayerNum !== turn.currentPlayer">
                    <span x-text="`Opponent Turn ${turn[utils.getOppositePlayerNum(myPlayerNum)].turnCount}`"></span>
                  </template>
                </div>
              </template>
              <template x-if="!turn.currentPlayer">
                <span>Waiting for Opponent...</span>
              </template>
            </li>
          </template>
        </menu>
      </header>

      <template x-if="!inGame">
        <div>
          <h1>To start the game join as a player</h1>
          <button @click="action.joinGame({player: 'player1'})" class="success" @keyup.window.1="$el.click()">
            Be Player <u>1</u>
          </button>
          <button @click="action.joinGame({player: 'player2'})" class="success" @keyup.window.2="$el.click()">
            Be Player <u>2</u>
          </button>
        </div>
      </template>

      <template x-if="inGame && targetMode.enabled && targetMode.help">
        <div class="panel target-mode-help">
          <span x-text="targetMode.help"></span>
          <br />
          <!-- TODO Add Escape key support to cancel targetMode -->
          <button @click="action.cancelTarget()" type="reset">Cancel</button>
        </div>
      </template>

      <!-- TODO Realistically we wouldn't even GET to this page without being a game (after joining from a lobby), so all these inGame checks will become needless-->
      <template x-if="inGame">
        <div
          id="drawCard"
          class="repositionable"
          draggable="true"
          @dragstart="repositionStart($event)"
          @dragend="repositionEnd($event, $el, [repositionOffsetX, repositionOffsetY])"
          x-init="repositionFromStorage($el.id)"
        >
          <span x-text="`${deckCount} Cards`" class="deck-card-count panel" title="Number of cards in the deck"></span>
          <span
            x-text="`${discardCount} Discard${discardCount > 1 ? 's' : ''}`"
            class="discard-card-count panel"
            title="Number of discarded cards"
          ></span>
          <div
            :class="'card-size bright-hover bd-variant' + (targetMode.enabled ? ' invalid-target' : '')"
            title="Draw a card for 2 Water (hotkey 'D')"
            @mouseover="showWaterCost(2)"
            @mouseout="hideWaterCost()"
            @click="hideWaterCost()"
          >
            <template x-if="deckCount > 0">
              <img
                @click="userDrawCard()"
                :src="fullCardPath('punk')"
                draggable="false"
                class="card-size"
              />
            </template>
          </div>
          <template x-if="!getPlayerData().hasWaterSilo">
            <div
              class="bright-hover take-water-silo"
              @mouseover="showWaterCost(1)"
              @mouseout="hideWaterCost()"
              @click="hideWaterCost()"
              title="Take the Water Silo for 1 Water (hotkey 'W')"
            >
              <img class="bd-accent" :src="fullCardPath('water_silo')" @click="userTakeWaterSilo()" />
            </div>
          </template>
          <template x-if="draggedCard">
            <div
              class="junk-pile card-size bd-attention"
              title="Drag your card here to use the Junk effect"
              @dragleave="dragLeaveHighlight($el, 'fg-attention')"
              @dragover.prevent="dragOverHighlight($el, 'fg-attention')"
              @drop.prevent="dropCardInJunk($el)"
            >
              <!-- TODO When hovering the Junk Card slot the trash icon could change to match an icon for draggedCard.junkEffect icon -->
              Junk Card
              <div class="icon">üóë</div>
            </div>
          </template>
        </div>
      </template>
      <template x-if="drawAnimationCount > 0">
        <template x-for="anim in drawAnimationCount">
          <img :src="fullCardPath('punk')" class="draw-animation card-size" />
        </template>
      </template>

      <template x-if="inGame && !targetMode.enabled && turn.currentPlayer && turn.currentPlayer === myPlayerNum">
        <!-- TODO Make this repositionable an Alpine directive? https://alpinejs.dev/advanced/extending#custom-directives -->
        <!-- Note this approach can be used on ANY element to make it repositionable in the page, requirements are id, draggable, @dragstart, @dragend, x-init, class="repositionable" -->
        <div
          id="waterTray"
          draggable="true"
          @dragstart="repositionStart($event)"
          @dragend="repositionEnd($event, $el, [repositionOffsetX, repositionOffsetY])"
          class="repositionable panel water-wrap bd-accent"
          x-init="repositionFromStorage($el.id)"
        >
          <template x-if="getPlayerData().waterCount > 0">
            <div>
              <template x-for="water in getPlayerData().waterCount">
                <img x-init="waterTokenEles.push($el)" src="images/water.png" class="water-token" draggable="false" />
              </template>
            </div>
          </template>
          <template x-if="getPlayerData().waterCount <= 0">
            <span>No Water remains</span>
          </template>
        </div>
      </template>

      <template x-if="inGame && getOpponentCamps().length">
        <div class="slots opponent-camps">
          <template x-for="camp in getOpponentCamps()">
            <div class="opponent-camp">
              <!-- TODO Better damage effect on opponent camps, currently with the built-in rotation the 'turn sideways for damage' style doesn't apply -->
              <img
                :id="`${targetModePrefix}${camp.id}`"
                draggable="false"
                :alt="camp.img"
                :src="getCampImage(camp)"
                class="card-size card-anim"
              />
            </div>
          </template>
          <span
            class="opponent-card-count panel"
            x-text="`${getOpponentCardCount()}\nCards`"
            title="Number of cards in the opponent's hand"
          ></span>
        </div>
      </template>

      <template x-if="inGame">
        <template x-for="(playerSlots, playerNum) in getSlots()">
          <div
            x-data="{ isMySlot: playerNum === myPlayerNum }"
            :class="'slots ' + (isMySlot ? 'my-slots' : 'opponent-slots')"
          >
            <template x-for="(slot, index) in playerSlots">
              <!-- TTODO Handle dragging Event card.isEvent, which should go in the event queue or junk only -->
              <div
                :id="isMySlot ? `${targetModePrefix}${SLOT_ID_PREFIX}${index}` : `opponent_${SLOT_ID_PREFIX}${index}`"
                class="bd-default relative"
                @dragleave="dragLeaveHighlight($el)"
                @dragover.prevent="isMySlot && dragOverSlot(slot, $el)"
                @drop.prevent="isMySlot && dropCardInSlot(slot, $el)"
              >
                <template x-if="slot.content">
                  <span>
                    <template x-if="isMySlot && slot.content.unReady">
                      <span>
                        <template
                          x-for="(water, index) in (slot.content.unReadyCost === 0 ? 1 : (slot.content.unReadyCost ?? 1))"
                        >
                          <img
                            :src="`images/${(slot.content.unReadyCost === 0 || !slot.content.unReadyCost) ? 'water_back' : 'water'}.png`"
                            class="water-token-overlay"
                            :style="`top: ${index*10}px; right: ${index*10}px;`"
                          />
                        </template>
                      </span>
                    </template>
                    <img
                      :id="`${targetModePrefix}${slot.content.id}`"
                      @click="isMySlot && !slot.content.unReady && action.useCard({details: { card: slot.content}})"
                      @mouseover="isMySlot && !slot.content.unReady && showWaterCost(getCheapestAbility(slot.content))"
                      @mouseout="isMySlot && !slot.content.unReady && hideWaterCost()"
                      draggable="false"
                      :alt="slot.content.img"
                      :src="fullCardPath(slot.content)"
                      :class="`bright-hover card-size card-anim slot-card ${isMySlot ? 'card-friendly' : 'card-opponent' } ${slot.content.unReady ? ' unready-card' : ''} ${slot.content.damage >= 1 ? ' damaged-card' : 'card'}`"
                    />
                  </span>
                </template>
              </div>
            </template>
          </div>
        </template>
      </template>

      <!-- TTODO Add Event queue UI to right of the board (make draggable though?), 3 slots numbered with bombs 1/2/3 -->
      <template x-if="inGame">
        <div
          id="eventQueue"
          draggable="true"
          @dragstart="repositionStart($event)"
          @dragend="repositionEnd($event, $el, [repositionOffsetX, repositionOffsetY])"
          class="repositionable panel event-queue bd-muted"
          x-init="repositionFromStorage($el.id)"
        >
          Event Queue
        </div>
      </template>

      <template x-if="inGame">
        <footer>
          <button
            x-ref="flipTray"
            @click="flipTray()"
            :class="'flip-tray ' + (trayIsCamps ? 'variant' : 'active')"
            title="Flip tray between your camps and hand"
          >
            <u>F</u>lip Tray
            <div class="icon">üóò</div>
            <span class="tray-subtext" x-text="trayIsCamps ? 'to Hand' : 'to Camps'"></span>
          </button>

          <fieldset :class="'panel tray ' + (trayIsCamps ? 'active' : 'variant')">
            <legend><span x-text="getTrayLegend()"></span></legend>

            <template x-for="camp in getMyCamps()">
              <div x-show="trayIsCamps">
                <img
                  :id="`${targetModePrefix}${camp.id}`"
                  draggable="false"
                  :alt="camp.img"
                  :src="getCampImage(camp)"
                  :class="'card-size card-anim ' + (typeof camp.damage === 'number' && camp.damage === 1 ? ' damaged-card' : '')"
                />
              </div>
            </template>

            <!-- TODO Space properly when no cards are in hand, or put a shrug emoji or something as a filler -->
            <template x-for="card in getMyCards()">
              <div x-show="trayIsCards && myPlayerNum">
                <img
                  :id="`${targetModePrefix}${card.id}`"
                  :alt="card.img"
                  :src="fullCardPath(card)"
                  :title="'Click and drag to play for ' + card.cost + ' Water'"
                  draggable="true"
                  @dragstart="draggedCard = card"
                  @dragend="draggedCard = null"
                  @mouseover="showWaterCost(card.cost)"
                  @mouseout="hideWaterCost()"
                  @error="$el.classList.add('card-error')"
                  class="card card-size"
                />
              </div>
            </template>
          </fieldset>
        </footer>
      </template>

      <!-- TODO Start simple with the chat & log, but go absolutely wild with features later - emojis, quick emotes, press up for last message, new message count in page title, trigger visual effects on opponent's screen, etc. -->
      <template x-if="inGame">
        <fieldset
          id="chatLog"
          class="repositionable chat panel bd-severe"
          draggable="true"
          @dragstart="repositionStart($event)"
          @dragend="repositionEnd($event, $el, [repositionOffsetX, repositionOffsetY])"
          x-init="repositionFromStorage($el.id)"
        >
          <legend class="severe" @click="applyChatMax({alsoUpdate: true})">
            Log <small>(press <b>T</b> to focus)</small>
            <div class="inline icon-sm">‚Ü®</div>
          </legend>
          <template x-if="chat.length === 0">
            <span>No messages yet...</span>
          </template>
          <div x-effect="scrollChatToBottom($el, chat.length, chatMax)" class="chat-wrap">
            <template x-for="message in chat">
              <div x-text="message"></div>
            </template>
          </div>
          <input x-ref="chatIn" x-model="currentChat" @keyup.enter="submitChat($el)" />
        </fieldset>
      </template>

      <template x-if="inGame" x-teleport="body">
        <dialog-camp-prompt />
      </template>

      <template x-teleport="body">
        <dialog-scientist-chooser />
      </template>

      <template x-teleport="body">
        <dialog-mutant-chooser />
      </template>

      <template x-teleport="body">
        <dialog-ability-chooser />
      </template>

      <template x-teleport="body">
        <dialog-discard-cards />
      </template>
    </section>

    <!-- JS scripts at the bottom like it's 1995 -->
    <script src="./clientjs/badlands.js"></script>
  </body>
</html>
